---
sidebar_position: 2
title: Auth0 x Permit Integration
---



## Introduction
Auth0 is the leading authentication platform for developers. While Permit.io is the leading authorization platform for developers.
By integrating Auth0 with Permit, you can easily add a secure, feature-rich and scalable authentication and authorization system to your application.

## What you’ll build
In this tutorial, you’ll learn how to integrate Auth0 with Permit to add a secure, feature-rich and scalable authentication and authorization system to your application.
We will have a WebApp that uses Auth0 for secure authentication and Permit for easy to manage authorization so we could change our application's permissions on the fly.

## Prerequisites
- [Auth0 account](https://auth0.com/signup)
- [Permit account](https://app.permit.io/)
- An application that use Auth0 for authentication, in this example we will use a NextJS app.

## Getting Started
## 1. Setting up Permit
### 1.1. Create the right roles in Permit
To sync user and roles from Auth0 to Permit, we need to create the same roles in Permit.

For our example App, we will create the following roles (it is recommended to use lower case keys because keys are case sensitive):

  * admin
  * manager
  * viewer
 
We can do it in the [Permit dashboard](https://app.permit.io/policy-editor/roles) or by using the [Permit API](https://api.permit.io/v2/redoc#tag/Roles/operation/create_role) or with one of our sdks [Python](https://docs.permit.io/sdk/python/usage-example/#create-a-role), [NodeJS](https://docs.permit.io/sdk/nodejs/usage-example#create-a-role) for more SDKs check out our SDK Reference section [inside the docs](https://docs.permit.io/).

### 1.2. Create the right resources in Permit
In our example, we will have a todo application, so we will create the `task` resource with the following actions:
- get
- post
- delete

We can do it in the [Permit dashboard](https://app.permit.io/policy-editor/resources) or by using the [Permit API](https://api.permit.io/v2/redoc#tag/Resources/operation/create_resource) or with one of our sdks [Python](https://docs.permit.io/sdk/python/usage-example/#create-a-resource), [NodeJS](https://docs.permit.io/sdk/nodejs/usage-example#create-a-resource) for more SDKs check out our SDK Reference section [inside the docs](https://docs.permit.io/).

### 1.3. Create the right permissions in Permit
Let's give the `admin` role all the permissions for the `task` resource.
The manager will have only the `get` and `post` permissions.
And the viewer will have only the `get` permission.
We can do it in the [Permit dashboard](https://app.permit.io/policy-editor) or by using the [Permit API](https://api.permit.io/v2/redoc#tag/Roles/operation/assign_permissions_to_role).


## 2. Run the demo application
### 2.1. Clone the demo application
```bash
git clone https://github.com/permitio/permit-next-todo-starter
git checkout auth0-permit-full-integration
```

### 2.2. put your Auth0 credentials in the .env file
To get your own keys in the desired format, use this link while logged in to your Auth0 account
```bash
AUTH0_SECRET='<auth0_secret>'
AUTH0_BASE_URL='http://localhost:3000'
AUTH0_ISSUER_BASE_URL='<auth0_issuer_base_url>'
AUTH0_CLIENT_ID=<auth0_client_id>
AUTH0_CLIENT_SECRET='<auth0_client_secret>'
```

### 2.3. put your Permit credentials in the .env file
You can get your Permit API Key from the [projects page](https://app.permit.io/projects) and by clicking on the three dots on the right of your environment and selecting `Copy API Key`.
_![Get Permit API key](/img/onboarding/secret-key-1.png)_


```bash
PERMIT_API_KEY=<permit_api_key>
```

## 3. Demo application explanation
### 3.1. Auth0
We will use Auth0 for authentication, so we will use the Auth0 SDK to get the user's information and to get the user's access token.
In the FE part we have the Auth0 `useUser` at `index.tsx` that will give us the user's information and the `userProvider` in `_app.tsx` that redirects the user to the login page if he is not logged in.
```tsx
// index.tsx
//...
  const { user, isLoading } = useUser();
//...
```
```tsx
// _app.tsx
//...
<UserProvider>
	<Component {...pageProps} />
</UserProvider>
//...
```
In the BE part we have the Auth0 `auth0` middleware at `pages/api/auth/[...auth0].ts` that will manage all auth0 related requests.
And also we can access Auth0 session in any API route by using the `getSession` function like we did in `pages/api/tasks.ts`.
```ts
// pages/api/auth/[...auth0].ts
import { handleAuth } from "@auth0/nextjs-auth0";

export default handleAuth();
```
```ts
// pages/api/tasks.ts
import { getSession } from "@auth0/nextjs-auth0";
//...
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
	const session = await getSession(req, res); // if the user is not logged in, session will be null
	if (!session?.user) {
    	res.status(401).json({ message: 'unauthorized' });
    	return;
  	}
//...
```

### 3.2. Permit
We will use Permit for authorization, so we will use the Permit SDK to get the user's permissions and to check if the user has the right permissions.
We only authorize in the BE of course, so we will use the `permit` middleware at `pages/api/tasks.ts` that will manage all permit related requests.
```ts
// pages/api/tasks.ts
import { Permit } from 'permitio';

export const permit = new Permit({
  pdp: 'https://cloudpdp.api.permit.io',
  token: process.env.PERMIT_SDK_TOKEN,
});
export default withApiAuthRequired(async function handler(
  req: NextApiRequest,
  res: NextApiResponse<Task | Task[] | Response>
) {
// Auth0 is checking if the user is logged in (who the user is)
  const session = await getSession(req, res);
  if (!session?.user) {
    res.status(401).json({ message: 'unauthorized' });
    return;
  }
// Permit is checking if the user has the right permissions (what the user can do)
  const isAllowedForOperation = await permit.check(
    session?.user?.sub as string || '', // the user identifier (Permit user id / or Permit user key, in this example we set the Auth0 user id as the key)
    req.method?.toLowerCase() as string, // the action (can be get, post, delete)
    'task' // our resource key
  );
  if (!isAllowedForOperation) {
    res.status(403).json({ message: 'forbidden' });
    return;
  }
  //... handle the request
});
```

## 4. The integration
Now that we have the user's information and the user's permissions, we can integrate them.
We need to make sure that Permit is synced with Auth0, so each user that logged in will have the right roles and permissions.

### 4.1. Sync Auth0 with Permit
The first thing that we need to do is to make sure each user that logged in to our app is synced with Permit.
We will do it in the `pages/api/auth/[...auth0].ts` file.
```ts
// pages/api/auth/[...auth0].ts
import { handleAuth, handleLogin } from "@auth0/nextjs-auth0";

export default handleAuth({
  async login(req, res) {
    await handleLogin(req, res, {
      returnTo: "/postLogin",
    });
  },
});
```
This will make sure that each user that logged in to our app will be navigated to the `postLogin` page.
Now we need to sync the user with Permit, so we will add the following code to the `postLogin` page.
In your application you will need to add this logic after each login.
```tsx
// pages/postLogin/index.tsx
export async function getServerSideProps({ req, res }: any) {
    const session = await getSession(req, res);
    const permitUserObj = {
        email: session?.user?.email,
        key: session?.user?.sub,
        first_name: session?.user?.name,
    }
    const permitUser = await permit.api.syncUser(permitUserObj);
	//... the sync role logic
}
```

This will sync the user with Permit, but we still need to add the user to the right roles.
We can use this (Auth0 guide)[https://auth0.com/docs/manage-users/access-control/sample-use-cases-rules-with-authorization#add-user-roles-to-tokens] to add the user's roles to the user's token.

I will add here a short explanation of how to do it. but use the Auth0 guide for more information.

Go to your Auth0 dashboard > Applications > API. Create API if you don't have one. Click on the three dots on the right of your API and click on settings. Scroll down to `RBAC Settings` and enable `Add Permissions in the Access Token`. Click on `Save Changes`. 

In short you need to navigate to the Auth0 dashboard and create a new rule https://manage.auth0.com/dashboard/[your-region]/[your-tenant-name]/rules.
The rule will look like this

```ts
function (user, context, callback) {
  const namespace = 'my_app_name';
  const assignedRoles = (context.authorization || {}).roles;

  let idTokenClaims = context.idToken || {};
  let accessTokenClaims = context.accessToken || {};

  idTokenClaims[`${namespace}/roles`] = assignedRoles;
  accessTokenClaims[`${namespace}/roles`] = assignedRoles;

  context.idToken = idTokenClaims;
  context.accessToken = accessTokenClaims;

  callback(null, user, context);
}
```
It will look like this: (of course you can set <my_app_name> to whatever you want)
```js
auth0User {
  'my_app_name/roles': [ 'admin' ],
  nickname: 'test',
  name: 'test@permit.io',
  picture: 'https://s.gravatar.com/avatar/test.png',
  updated_at: '2023-07-05T10:56:35.831Z',
  email: 'test@permit.io',
  email_verified: false,
  sub: 'auth0|64a139da377fefdcbxxxxxxx',
  sid: 'I9xntALjR3M37Iw62Lgc3xxxxxxxxxx'
}
```
Then when the user will log in to our app, we can sync also the user's roles with Permit.
And add this just below the `permit.api.syncUser` function.
```tsx
    if (session?.user['my_app_name/roles']) {
        session?.user['my_app_name/roles'].map(async (roleKey: string) => {
            console.log(roleKey);
            const roleToAssign = {
                role: roleKey,
                user: permitUserObj.key,
                tenant: 'default'
            }
            const assignedRole = await permit.api.assignRole(roleToAssign);
            console.log(assignedRole);
        });
    }
    redirect(res, 302, '/');
}
```

Now if you will assign a role to a user whether in Auth0 or in Permit, the user will have the right roles and permissions. (make sure you are using the exact same role name in Auth0 and in Permit case sensitive)

[Check out the postLogin page in this example to see the full code.](https://github.com/permitio/permit-next-todo-starter)

#### 4.2. Removing a user
If you want to remove a user from your app, make sure you remove the user from Auth0 and from Permit as well.
You can do it by adding this code to your remove user function.
```ts
    const removedUser = await permit.api.deleteUser(permitUserObj.key);
```

### 5. Let's test it
Create a new user in Auth0 and assign the `manager` role to it.
Then log in to the app with the new user.
You should be able to create tasks but not to delete them.
Now go to [Permit policy editor](https://app.permit.io/policy-editor) and add the delete action to the `manager` role and save the policy.

Or you can go to [Permit user management](https://app.permit.io/user-management) and add the `admin` role to the logged in user.
Now you should be able to delete tasks immediately without logging out and logging in again.

:::note info
 If you remove a role in Permit but the user still has the role in Auth0, our code will assign the role again to the user.
You can fix it by adding this code to the begging of the postLogin function:
:::
```ts
    const session = await getSession(req, res);
    // check if user exists in permit
    const user = await permit.api.getUser(session?.user?.sub);
    if (user) {
        console.log('user exists');
        redirect(res, 302, '/');
        return { props: {} };
    }
```
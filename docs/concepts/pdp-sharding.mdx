---
sidebar_position: 5
title: PDP Sharding
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# What is PDP Sharding ?

[PDP](/concepts/pdp) Sharding is a technique for scaling Policy Decision Points (PDPs) horizontally,
by splitting the data into multiple PDPs, each responsible for a subset of your tenants.

## When to use PDP Sharding

PDP Sharding is useful when you need to scale your PDP horizontally,
In some cases it is more cost effective to run multiple smaller PDPs, than a single large one because the policy engines
might not handle large amount of data as quickly as you need them to.

# How it works ?

Each PDP is run with a specific shard ID (a number between 0 and the number of shards - 1),
each shard will have only the data of the tenants associated with it.
On top of your PDPs an [Envoy server](https://www.envoyproxy.io/docs/envoy/latest/) will proxy each authorization query request to handle the consistent hashing algorithm
that will be used to map each request by its tenant to the consistent shard responsible for it.
This is done by utilizing Envoy's native support for “Hash ring” load balancing.
That is, choosing an upstream host using a consistent hashing algorithm (“Ketama”).

Data changes tracked by Permit.io are propagated to the specific PDP shard that is responsible for associated with them. The same consistent hashing algorithm will be used to map the data to the correct shard.

## Basic Architecture

The flow of an authorization request will be as follows:
![Authorization Request](/img/diagrams/sharded-pdps-diagram.svg)

To achieve sharding, multiple PDPs should be run.
Currently, a predeterimned number of PDPs is assumed, although dynamic scaling would be available soon as well (upcoming feature).

For each SDK query to reach the correct PDP instance (holding the shard that has the correct tenant id), we are using Envoy.
The SDK is configured with Envoy’s address as its PDP, and Envoy forwards the requests based on the Tenant ID to the corresponding PDP.
Permit.io's backend uses that very same sharding algorithm, Thus both the locally deployed Envoy proxy and the Permit.io backend are mapping the same tenant ids to the same shard ids.

## Quickstart

An Envoy container with a custom configuration should be deployed next to the set of PDPs.
See quick guide [here](https://www.envoyproxy.io/docs/envoy/latest/start/quick-start/run-envoy#override-the-default-configuration).
The following configuration should be used:

1. Create a docker network for the envoy and pdp containers to communicate:
   ```sh
   docker network create pdp-net
   ```
2. Create the envoy configuration file:

   ```yaml
   admin:
     address:
       socket_address: { address: 0.0.0.0, port_value: 9901 }

   static_resources:
     listeners:
       - name: sdk_requests
         address:
           socket_address: { address: 0.0.0.0, port_value: 80 }
         filter_chains:
           - filters:
               - name: envoy.filters.network.http_connection_manager
                 typed_config:
                   "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                   stat_prefix: ingress_http
                   codec_type: AUTO
                   route_config:
                     name: local_route
                     virtual_hosts:
                       - name: local_service
                         domains: ["*"]
                         routes:
                           - match: { prefix: "/allowed" }
                             route:
                               cluster: pdp_cluster
                               hash_policy:
                                 - header:
                                     header_name: X-Tenant-Id
                   http_filters:
                     - name: envoy.filters.http.router
                       typed_config:
                         "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
     clusters:
       - name: pdp_cluster
         connect_timeout: 0.25s
         type: STRICT_DNS
         lb_policy: RING_HASH
         dns_lookup_family: V4_ONLY
         load_assignment:
           cluster_name: pdp_cluster
           endpoints:
             - lb_endpoints:
                 - endpoint:
                     address:
                       socket_address:
                         # replace the address with the PDP's address
                         address: pdp-0
                         port_value: 7766
                   metadata:
                     filter_metadata:
                       envoy.lb:
                         hash_key: 0
                 - endpoint:
                     address:
                       socket_address:
                         # replace the address with the PDP's address
                         address: pdp-1
                         port_value: 7766
                   metadata:
                     filter_metadata:
                       envoy.lb:
                         hash_key: 1
   ```

3. Run Envoy:
   ```sh
   docker run --rm -it --network=pdp-net \
     -v $(pwd)/pdp-lb-envoy.yaml:/envoy-custom.yaml \
     -p 9901:9901 \
     -p 10000:10000 \
     envoyproxy/envoy:v1.26-latest \
         -c /envoy-custom.yaml
   ```
4. Run PDPs:
   Each PDP should get its shard id as an environment variable:
   ```sh
   docker run -it \
     -p 7766:7000 \
     --name pdp-0 \
     --network=pdp-net \
     --env PDP_API_KEY=<YOUR_API_KEY> \
     --env PDP_SHARD_ORD=0 \
     permitio/pdp-v2:latest
   ```
   and
   ```sh
   docker run -it \
     -p 7766:7000 \
     --name pdp-1 \
     --network=pdp-net \
     --env PDP_API_KEY=<YOUR_API_KEY> \
     --env PDP_SHARD_ORD=1 \
     permitio/pdp-v2:latest
   ```

Finally you can send an authorization check request to the Envoy container:

<Tabs groupId="language">
<TabItem value="curl" label="cURL">

```bash
curl http://localhost:10000/allowed \
    -X POST \
    -H "X-Tenant-Id: default" \
    -H "Authorization: Bearer <YOUR_API_KEY>" \
    -H "Content-Type: application/json" \
    -d '{
            "user": {
                "key": "user@example.com"
            },
            "resource": {
                "tenant": "default",
                "type": "document",
            },
                "action": "read"
        }'
```

</TabItem>
<TabItem value="python" label="Python">

```python
await permit.check(
    # user
    "user@example.com",
    # action
    "read",
    # resource
    {
        "type": "document",
        "tenant": "default",
    },
)
```

</TabItem>
<TabItem value="nodejs" label="Node.js">

```javascript
await permit.check(
  // user
  "user@example.com",
  // action
  "read",
  // resource
  {
    type: "document",
    tenant: "default",
  }
);
```

</TabItem>
</Tabs>

**Note:** Sharded PDPs are currently available only for early-access-program customers, make sure to [contact us](https://io.permit.io/docs-to-slack) to get access to it.
